---
- name: Deploy Expense Tracker Application
  hosts: ec2_instances
  become: yes
  vars:
    app_dir: /home/ubuntu/expense-tracker
    # These match the tags you set in your Jenkinsfile
    docker_hub_user: "maheeshamihiran"
    
  tasks:
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copy production docker-compose to EC2
      # This copies your hub-specific compose file and renames it to docker-compose.yaml on the server
      copy:
        src: ../docker-compose.hub.yml 
        dest: "{{ app_dir }}/docker-compose.yaml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Copy environment file
      # Jenkins generates/contains the .env; we move it to the app folder
      copy:
        src: ../.env
        dest: "{{ app_dir }}/.env"
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      ignore_errors: yes

    - name: Stop existing containers
      command: docker-compose down
      args:
        chdir: "{{ app_dir }}"
      ignore_errors: yes

    - name: Pull latest Docker images from Hub
      command: docker-compose pull
      args:
        chdir: "{{ app_dir }}"
      become_user: ubuntu

    - name: Start containers with docker-compose
      command: docker-compose up -d
      args:
        chdir: "{{ app_dir }}"
      become_user: ubuntu

    - name: Wait for services to become healthy
      wait_for:
        port: "{{ item }}"
        delay: 5
        timeout: 60
      loop:
        - 3000  # Frontend
        - 4000  # Backend
        - 27017 # MongoDB

    - name: Verify running containers
      command: docker ps
      register: docker_ps
      become_user: ubuntu

    - name: Display running containers
      debug:
        msg: "{{ docker_ps.stdout_lines }}"

    - name: Clean up unused Docker images (Prune)
      command: docker image prune -f
      become_user: ubuntu