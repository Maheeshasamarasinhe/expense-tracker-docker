---
- name: Deploy Expense Tracker Application
  hosts: ec2_instances
  become: yes
  vars:
    app_dir: /home/ubuntu/expense-tracker
    docker_hub_user: "maheeshamihiran"
    
  tasks:
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copy production docker-compose to EC2
      copy:
        src: ../docker-compose.hub.yml 
        dest: "{{ app_dir }}/docker-compose.yaml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Stop existing containers
      shell: docker compose down
      args:
        chdir: "{{ app_dir }}"
      ignore_errors: yes

    - name: Pull latest Docker images from Hub
      shell: docker compose pull
      args:
        chdir: "{{ app_dir }}"
      become_user: ubuntu

    - name: Start containers with docker-compose
      shell: docker compose up -d
      args:
        chdir: "{{ app_dir }}"
      become_user: ubuntu

    - name: Wait for services to become healthy
      wait_for:
        port: "{{ item }}"
        delay: 10
        timeout: 120
      loop:
        - 3000  # Frontend
        - 4000  # Backend

    - name: Verify running containers
      command: docker ps
      register: docker_ps
      become_user: ubuntu

    - name: Display running containers
      debug:
        msg: "{{ docker_ps.stdout_lines }}"

    - name: Clean up unused Docker images
      command: docker image prune -f
      become_user: ubuntu